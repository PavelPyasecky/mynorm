name: Deploy to Stage

on:
  push:
    branches:
      - stage
  workflow_dispatch:

env:
  DEPLOY_PATH: /root/mynorm
  DOCKER_COMPOSE_FILE: docker-compose.production.yml

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read and increment version
        id: version
        run: |
          if [ -f VERSION ]; then
            CURRENT_VERSION=$(cat VERSION | tr -d ' \n\r')
            echo "Current version: $CURRENT_VERSION"
            
            # Parse semantic version (MAJOR.MINOR.PATCH)
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
            
            # Increment patch version
            PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            
            echo "$NEW_VERSION" > VERSION
            echo "New version: $NEW_VERSION"
            
            echo "semantic_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Version: $NEW_VERSION"
          else
            echo "semantic_version=0.0.0" >> $GITHUB_OUTPUT
            echo "âš ï¸  VERSION file not found"
          fi

      - name: Commit updated VERSION file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git add VERSION
          if git diff --staged --quiet; then
            echo "No changes to VERSION file"
          else
            git commit -m "chore: bump version to ${{ steps.version.outputs.semantic_version }} [skip ci]"
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
            git push origin HEAD:$BRANCH_NAME || echo "âš ï¸  Failed to push VERSION update"
          fi

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Pull code and deploy on VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF
            set -e
            cd ${{ env.DEPLOY_PATH }}
            
            BRANCH_NAME="${{ github.ref_name }}"
            echo "ðŸ“¥ Pulling latest code from \$BRANCH_NAME branch..."
            git fetch origin
            git checkout \$BRANCH_NAME
            git pull origin \$BRANCH_NAME
            
            echo "ðŸ”¨ Building Docker containers..."
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} build --no-cache
            
            echo "ðŸ›‘ Stopping existing containers..."
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} down
            
            echo "ðŸš€ Starting containers..."
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} up -d
            
            echo "â³ Waiting for services to start..."
            sleep 30
            
            echo "ðŸ” Checking service status..."
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} ps
            
            echo "ðŸ“‹ Checking Django logs..."
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} logs django --tail=20
          EOF

      - name: Health check
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            cd ${{ env.DEPLOY_PATH }}
            
            echo "ðŸ§ª Running health checks..."
            
            # Check if Django is responding
            if docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} exec -T django python manage.py check --deploy; then
              echo "âœ… Django health check passed"
            else
              echo "âŒ Django health check failed"
              exit 1
            fi
            
            # Test API endpoints
            if curl -f -I https://dev-314.ru/api/health/; then
              echo "âœ… API health endpoint check passed"
            else
              echo "âŒ API health endpoint check failed"
              exit 1
            fi
            
            # Check if drf_spectacular is installed
            if docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} exec -T django python -c "import drf_spectacular; print('âœ… drf_spectacular installed')"; then
              echo "âœ… drf_spectacular check passed"
            else
              echo "âŒ drf_spectacular check failed"
              exit 1
            fi
          EOF

      - name: Cleanup old images
        if: always()
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            echo "ðŸ§¹ Cleaning up old Docker images..."
            docker image prune -f
          EOF

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Stage deployment successful!"
          else
            echo "âŒ Stage deployment failed!"
          fi
